name: ğŸš€ Build All Kernels and Create Release

on:
  workflow_dispatch:
    inputs:
      RELEASE_TAG:
        description: 'Release tag name (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      CLEAN_BUILD:
        description: 'Perform clean build'
        type: boolean
        default: true

env:
  RELEASE_NAME: 'KernelSU Builds'

jobs:
  # ç¬¬ä¸€æ­¥ï¼šè§¦å‘æ‰€æœ‰ç°æœ‰çš„workflow
  trigger-workflows:
    name: ğŸ”¥ Trigger All Build Workflows
    runs-on: ubuntu-latest
    outputs:
      workflow-status: ${{ steps.trigger-all.outputs.workflow-status }}
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Discover Workflows
        id: discover
        run: |
          echo "Discovering workflows in repository..."
          WORKFLOWS=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | grep -v "build_all" | sed 's|./.github/workflows/||')
          echo "Found workflows:"
          echo "$WORKFLOWS"
          echo "workflows=$(echo $WORKFLOWS | jq -R -s -c 'split("\n") | map(select(. != ""))')" >> $GITHUB_OUTPUT

      - name: ğŸš€ Trigger All Build Workflows
        id: trigger-all
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOWS='${{ steps.discover.outputs.workflows }}'
          echo "Workflows to trigger: $WORKFLOWS"
          
          # è½¬æ¢ä¸ºæ•°ç»„
          WORKFLOW_ARRAY=$(echo "$WORKFLOWS" | jq -r '.[]')
          
          STATUS_ARRAY=()
          
          for workflow in $WORKFLOW_ARRAY; do
            if [[ "$workflow" != "build-all-release.yml" && "$workflow" != *"build_all"* ]]; then
              echo "ğŸš€ Triggering workflow: $workflow"
              
              # è·å–workflow ID
              WORKFLOW_ID=$(curl -s \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$workflow" | \
                jq -r '.id')
              
              if [[ "$WORKFLOW_ID" != "null" && -n "$WORKFLOW_ID" ]]; then
                # è§¦å‘workflow
                RESPONSE=$(curl -s -X POST \
                  -H "Authorization: Bearer $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/dispatches" \
                  -d "{
                    \"ref\": \"${{ github.ref }}\",
                    \"inputs\": {
                      \"FAST_BUILD\": \"true\",
                      \"LSM\": \"true\",
                      \"SCHED\": \"false\"
                    }
                  }")
                
                if [[ $(echo "$RESPONSE" | jq -r '.message') == "null" ]]; then
                  echo "âœ… Successfully triggered: $workflow"
                  STATUS_ARRAY+=("$workflow:success")
                else
                  echo "âŒ Failed to trigger: $workflow - $RESPONSE"
                  STATUS_ARRAY+=("$workflow:failed")
                fi
              else
                echo "âš ï¸ Could not find workflow ID for: $workflow"
                STATUS_ARRAY+=("$workflow:not_found")
              fi
              
              # æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
              sleep 3
            fi
          done
          
          # è¾“å‡ºçŠ¶æ€
          echo "workflow-status=$(echo ${STATUS_ARRAY[@]} | jq -R -s -c 'split(" ")')" >> $GITHUB_OUTPUT

  # ç¬¬äºŒæ­¥ï¼šç­‰å¾…æ‰€æœ‰workflowå®Œæˆå¹¶æ”¶é›†artifacts
  collect-artifacts:
    name: ğŸ“¦ Collect Artifacts and Create Release
    runs-on: ubuntu-latest
    needs: trigger-workflows
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â³ Wait for Builds to Complete
        run: |
          echo "â° Waiting for all triggered workflows to complete..."
          echo "This is a simplified wait - in production you might want to implement proper polling"
          sleep 300  # ç­‰å¾…5åˆ†é’Ÿè®©buildså¼€å§‹

      - name: ğŸ” Find Latest Artifacts
        id: find-artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Searching for recent artifacts..."
          
          # è·å–æœ€è¿‘24å°æ—¶å†…çš„artifacts
          ARTIFACTS_JSON=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?per_page=100")
          
          # è¿‡æ»¤å‡ºå†…æ ¸ç›¸å…³çš„artifacts
          KERNEL_ARTIFACTS=$(echo "$ARTIFACTS_JSON" | \
            jq -r '.artifacts[] | select(.name | contains("Kernel") or contains("AnyKernel")) | "\(.id),\(.name),\(.created_at)"' | \
            sort -t, -k3 -r | head -20)
          
          echo "Found artifacts:"
          echo "$KERNEL_ARTIFACTS"
          
          # åˆ›å»ºä¸‹è½½åˆ—è¡¨
          DOWNLOAD_LIST=""
          while IFS=, read -r id name created_at; do
            if [[ -n "$id" && -n "$name" ]]; then
              DOWNLOAD_LIST+="$id,$name"$'\n'
            fi
          done <<< "$KERNEL_ARTIFACTS"
          
          echo "download_list<<EOF" >> $GITHUB_OUTPUT
          echo "$DOWNLOAD_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ Download Artifacts
        uses: actions/github-script@v6
        env:
          DOWNLOAD_LIST: ${{ steps.find-artifacts.outputs.download_list }}
        with:
          script: |
            const downloadList = process.env.DOWNLOAD_LIST;
            const lines = downloadList.trim().split('\n');
            
            for (const line of lines) {
              const [artifactId, artifactName] = line.split(',');
              if (artifactId && artifactName) {
                console.log(`ğŸ“¥ Downloading: ${artifactName} (${artifactId})`);
                
                // ä¸‹è½½artifact
                const downloadUrl = await github.rest.actions.downloadArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: parseInt(artifactId),
                  archive_format: 'zip',
                });
                
                // ä¿å­˜æ–‡ä»¶
                const fs = require('fs');
                const path = require('path');
                const artifactsDir = './artifacts-collected';
                
                if (!fs.existsSync(artifactsDir)) {
                  fs.mkdirSync(artifactsDir, { recursive: true });
                }
                
                // è¿™é‡Œéœ€è¦å®é™…å¤„ç†ä¸‹è½½é€»è¾‘
                // ç”±äºgithub-scripté™åˆ¶ï¼Œå®é™…ä¸‹è½½å¯èƒ½éœ€è¦ä½¿ç”¨å…¶ä»–action
                console.log(`âœ… Would download: ${artifactName}`);
              }
            }

      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.RELEASE_TAG }}
          release_name: "${{ env.RELEASE_NAME }} - ${{ github.event.inputs.RELEASE_TAG }}"
          body: |
            # ğŸš€ KernelSU Build Collection
            
            ## Build Information
            - **Build Date**: ${{ fromJSON('{"date": "'$(date -I)'"}').date }}
            - **Triggered By**: @${{ github.actor }}
            - **Repository**: ${{ github.repository }}
            - **Commit**: ${{ github.sha }}
            
            ## ğŸ“± æ”¯æŒè®¾å¤‡
            - OnePlus ACE 2
            
            ## âš ï¸ è­¦å‘Š
            åˆ·å†™å‰è¯·å¤‡ä»½åŸbooté˜²æ­¢å˜ç –
            
            ## ğŸ”§ ç‰¹æ€§
            - é›†æˆLSM
            - è‡ªå¸¦SUSFS

            ## â˜… ç‰¹åˆ«é¸£è°¢
            [https://github.com/Numbersf/]æ‰€æœ‰è„šæœ¬éƒ½æ˜¯æ ¹æ®å¤§ä½¬äºŒæ”¹ï¼Œæœ‰èƒ½åŠ›ç‚¹ä¸ªSTAR
            
          draft: false
          prerelease: false
          files: |
            artifacts-collected/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç¬¬ä¸‰æ­¥ï¼šæ¸…ç†å’ŒçŠ¶æ€æŠ¥å‘Š
  cleanup-and-report:
    name: ğŸ§¹ Cleanup and Report
    runs-on: ubuntu-latest
    needs: [trigger-workflows, collect-artifacts]
    if: always()
    
    steps:
      - name: ğŸ“Š Build Status Report
        run: |
          echo "## ğŸ“Š Build Execution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”¥ Triggered Workflows:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          STATUS_ARRAY='${{ needs.trigger-workflows.outputs.workflow-status }}'
          echo "Raw status: $STATUS_ARRAY"
          
          if [[ "$STATUS_ARRAY" != "null" && -n "$STATUS_ARRAY" ]]; then
            echo "$STATUS_ARRAY" | jq -r '.[]' | while read status; do
              workflow=$(echo "$status" | cut -d: -f1)
              state=$(echo "$status" | cut -d: -f2)
              
              case $state in
                "success")
                  echo "âœ… $workflow - Successfully triggered" >> $GITHUB_STEP_SUMMARY
                  ;;
                "failed")
                  echo "âŒ $workflow - Failed to trigger" >> $GITHUB_STEP_SUMMARY
                  ;;
                "not_found")
                  echo "âš ï¸ $workflow - Workflow not found" >> $GITHUB_STEP_SUMMARY
                  ;;
                *)
                  echo "â“ $workflow - Unknown status: $state" >> $GITHUB_STEP_SUMMARY
                  ;;
              esac
            done
          else
            echo "No workflow status information available." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Release Information:" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ github.event.inputs.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.collect-artifacts.result }}" == "success" ]]; then
            echo "âœ… Release created successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Release creation failed!" >> $GITHUB_STEP_SUMMARY
          fi
